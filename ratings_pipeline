import os
from dotenv import load_dotenv
import openai
import cv2
# Load environment variables from .env file
load_dotenv()

# Get the API key from environment variables
openai.api_key = os.getenv("OPENAI_API_KEY")

# Define the prompt to process the text
prompt = """
"""


def extract_frames_quarter_second(video_path, output_folder):
    # Open the video file
    cap = cv2.VideoCapture(video_path)

    # Get the frame rate (FPS) of the video
    fps = cap.get(cv2.CAP_PROP_FPS)
    total_frames = int(cap.get(cv2.CAP_PROP_FRAME_COUNT))
    duration = total_frames / fps  # Calculate the total duration of the video in seconds
    
    # Make the output folder if it doesn't exist
    if not os.path.exists(output_folder):
        os.makedirs(output_folder)

    frame_count = 0
    extracted_frames = 0

    # Iterate over every 1/4 second of the video
    for quarter_second in range(int(duration * 4)):  # Multiply duration by 4 to get 1/4 second intervals
        target_frame = quarter_second * (fps / 4)  # Target frame for the current 1/4 second
        cap.set(cv2.CAP_PROP_POS_FRAMES, target_frame)  # Move to that frame

        # Read the frame
        ret, frame = cap.read()
        if ret:
            frame_filename = os.path.join(output_folder, f"{os.path.basename(video_path)}_frame_{quarter_second}.jpg")
            cv2.imwrite(frame_filename, frame)  # Save the frame
            extracted_frames += 1

        frame_count += 1

    # Release the video capture object
    cap.release()

# Function to process image frame with OpenAI (e.g., using CLIP for image/text analysis)
def process_frame_with_openai(image_path):
    try:
        with open(image_path, "rb") as image_file:
            response = openai.Image.create(
                prompt=f'You are a driver in an autonomous car. You’re {age} years old. Watch the following video that shows what happens in the surroundings and the driving situation and rate your reaction to what you see based on the following questions. Use the scales provided in the brackets for each question. When there are two adjectives to compare the left value corresponds to the left adjective and the right value to the right one. Don’t respond with an analysis or any other comments (give just the ratings). Provide the response in a csv file.',  
                n=1,
                size="1024x1024",
                file=image_file
            )

            # Extract and return the description from OpenAI's response
            return response['data'][0]['text']

    except Exception as e:
        print(f"Error processing {image_path}: {e}")
        return None

# Process the video: Extract frames and send them to OpenAI
def process_video_with_openai(video_path, output_folder):
    # Step 1: Extract frames from the video
    extract_frames_quarter_second(video_path, output_folder)

    # Step 2: Process each frame with OpenAI
    for frame_filename in os.listdir(output_folder):
        frame_path = os.path.join(output_folder, frame_filename)
        
        # Process the frame with OpenAI (e.g., CLIP for image/text analysis)
        description = process_frame_with_openai(frame_path)

        if description:
            print(f"Description for {frame_filename}: {description}")
        else:
            print(f"Failed to process {frame_filename}")



folder_path = 'videos_path'
ratings_folder = 'ratings'

video_files = [f for f in os.listdir(folder_path) if f.endswith(('.mp4', '.mkv', '.avi'))]

video_files = [os.path.join(folder_path, video) for video in video_files]

age_list = ['18-24', '25-34', '35-44', '45-54', '55-64', '65+']

for file in video_files:
    for age in age_list:
        age = age
    print(f"Processing video: {file}")
    process_video_with_openai(file, output_folder)
    print(f"Finished processing video: {file}")